<!--
BACK TEMPLATE
- Shows the cloze again (answer side).
- Optional Extra field.
- Resource hint pills (UWorld/AMBOSS/FA/etc).
- Clicking a pill toggles its hint block.
- When opened, the SAME pill moves above its own content block.
- "H" key still works: Anki reveals the hint internally; JS captures it and renders it.
- NOTE: Do NOT write Anki template syntax like double-curly braces inside comments,
  because Anki will parse it and error if the field doesn't exist.
-->

<div class="card-wrapper">

  <div class="question">
    <div class="clozefield">{{cloze:Text}}</div>
    <div class="editcloze">{{edit:cloze:Text}}</div>
  </div>

  {{#Extra}}
  <div class="extra">{{Extra}}</div>
  {{/Extra}}

  <!--
  Hint row:
  Each resource uses the Anki hint helper (e.g., ⟨hint:UWorld_2CK⟩).
  That helper generates:
  - a clickable link (class "hint")
  - a hidden payload div (class "hint") containing the field HTML
  We hide the payload with CSS and render the HTML into blocks ourselves.
  -->
  <div id="hintRow">
    {{#UWorld_2CK}}<span class="pill uworld">{{hint:UWorld_2CK}}</span>{{/UWorld_2CK}}
    {{#AMBOSS}}<span class="pill amboss">{{hint:AMBOSS}}</span>{{/AMBOSS}}
    {{#First_Aid}}<span class="pill fa">{{hint:First_Aid}}</span>{{/First_Aid}}
    {{#Kaplan}}<span class="pill kaplan">{{hint:Kaplan}}</span>{{/Kaplan}}
    {{#Pathoma}}<span class="pill pathoma">{{hint:Pathoma}}</span>{{/Pathoma}}
    {{#UpToDate}}<span class="pill utd">{{hint:UpToDate}}</span>{{/UpToDate}}
    {{#NBME}}<span class="pill nbme">{{hint:NBME}}</span>{{/NBME}}
    {{#Additional_Resources}}<span class="pill add">{{hint:Additional_Resources}}</span>{{/Additional_Resources}}
  </div>

  <!-- Expanded hint blocks are injected here -->
  <div id="hintContentArea"></div>

</div>

<script>
(function () {
  const row  = document.getElementById("hintRow");
  const area = document.getElementById("hintContentArea");
  if (!row || !area) return;

  const placeholders = new Map();
  const movedPills   = new Map();

  function esc(s){ return (s||"").replace(/\\/g,"\\\\").replace(/"/g,'\\"'); }

  function pillClassOf(a){
    const pill = a.closest(".pill");
    if (!pill) return "";
    return [...pill.classList].filter(c => c !== "pill").join(" ");
  }

  function keyOf(a){
    if (a.dataset.hkey) return a.dataset.hkey;
    const k = (a.textContent || "").trim() + "||" + pillClassOf(a);
    a.dataset.hkey = k;
    return k;
  }

  function getBlock(key){
    return area.querySelector('.hintBlock[data-key="' + esc(key) + '"]');
  }

  function setExpanded(a, on){
    a.classList.toggle("activeHint", on);
    a.setAttribute("aria-expanded", on ? "true" : "false");
  }

  function siblingHint(a){
    const d = a.nextElementSibling;
    return d && d.classList && d.classList.contains("hint") ? d : null;
  }

  function findPillSpanForLink(a){
    return a.closest(".pill");
  }

  function movePillIntoBlock(key, pillSpan, header){
    if (!pillSpan || !header) return;

    if (!placeholders.has(key)) {
      const ph = document.createElement("span");
      ph.className = "pillPlaceholder";
      ph.dataset.key = key;
      ph.style.display = "none";
      pillSpan.parentNode.insertBefore(ph, pillSpan);
      placeholders.set(key, ph);
    }

    movedPills.set(key, pillSpan);
    header.appendChild(pillSpan);
  }

  function movePillBackToRow(key){
    const pillSpan = movedPills.get(key);
    const ph = placeholders.get(key);
    if (!pillSpan || !ph) return;

    ph.parentNode.insertBefore(pillSpan, ph);
    ph.remove();

    movedPills.delete(key);
    placeholders.delete(key);
  }

  function addBlockFromHtml(html, key, link){
    const block = document.createElement("div");
    block.className = "hintBlock";
    block.dataset.key = key;
    block.innerHTML = `
      <div class="hintHeader"></div>
      <div class="hintBody">${html}</div>
    `;
    area.appendChild(block);

    const header = block.querySelector(".hintHeader");
    const pillSpan = findPillSpanForLink(link);
    movePillIntoBlock(key, pillSpan, header);

    setExpanded(link, true);
    block.scrollIntoView({ block:"nearest", behavior:"smooth" });
  }

  function closeBlock(key, link){
    const b = getBlock(key);
    if (b) b.remove();
    movePillBackToRow(key);
    if (link) setExpanded(link, false);
  }

  document.addEventListener("click", (e) => {
    const a = e.target.closest("a.hint");
    if (!a) return;

    const inOurSystem = a.closest("#hintRow") || a.closest("#hintContentArea");
    if (!inOurSystem) return;

    const key = keyOf(a);

    if (getBlock(key)) {
      e.preventDefault();
      closeBlock(key, a);
      const d = siblingHint(a);
      if (d) d.style.display = "none";
      return;
    }

    const d = siblingHint(a);
    if (d) {
      e.preventDefault();
      addBlockFromHtml(d.innerHTML, key, a);
      d.style.display = "none";
    }
  }, true);

  function captureVisible(){
    const divs = [...row.querySelectorAll("div.hint")].filter(d => d.offsetHeight > 0);
    divs.forEach(d => {
      const a = d.previousElementSibling;
      if (!a || !a.classList || !a.classList.contains("hint")) return;

      const key = keyOf(a);
      if (!getBlock(key)) addBlockFromHtml(d.innerHTML, key, a);
      else setExpanded(a, true);

      d.style.display = "none";
    });
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "h" || e.key === "H") setTimeout(captureVisible, 0);
  });
})();
</script>
