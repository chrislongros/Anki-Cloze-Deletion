<!-- =========================================================
     BACK TEMPLATE
     ---------------------------------------------------------
     Features:
     - Shows the cloze again (answer side).
     - Optional "Extra" field below the cloze.
     - Hint pills for multiple resources (UWorld/AMBOSS/FA/etc.).
     - Clicking a pill toggles its hint block:
         - first click opens the block
         - second click closes the block
     - When opened, the SAME pill is moved above its own content
       block (so you can always collapse it in-place).
     - Supports Anki's native "H" (show hint) behavior:
         - user presses H
         - Anki reveals the hint internally
         - our script captures that revealed HTML and renders it
           into a hint block (then hides the native hint payload)
     ========================================================= -->

<div class="card-wrapper">

  <div class="question">
    <!-- Normal cloze rendering (answer side) -->
    <div class="clozefield">{{cloze:Text}}</div>

    <!-- EFDR editable cloze rendering -->
    <div class="editcloze">{{edit:cloze:Text}}</div>
  </div>

  <!-- Optional additional explanation / notes -->
  {{#Extra}}
  <div class="extra">{{Extra}}</div>
  {{/Extra}}

  <!-- =======================================================
       HINT PILL ROW (PRE-EXPANSION)
       -------------------------------------------------------
       Each field is wrapped in Anki's {{hint:Field}} helper.
       This generates:
         - an <a class="hint">…</a> link (the clickable pill)
         - a hidden <div class="hint">…</div> payload (the content)
       We hide the payload via CSS and render it ourselves.
       ======================================================= -->

  <div id="hintRow">
    {{#UWorld_2CK}}<span class="pill uworld">{{hint:UWorld_2CK}}</span>{{/UWorld_2CK}}
    {{#AMBOSS}}<span class="pill amboss">{{hint:AMBOSS}}</span>{{/AMBOSS}}
    {{#First_Aid}}<span class="pill fa">{{hint:First_Aid}}</span>{{/First_Aid}}
    {{#Kaplan}}<span class="pill kaplan">{{hint:Kaplan}}</span>{{/Kaplan}}
    {{#Pathoma}}<span class="pill pathoma">{{hint:Pathoma}}</span>{{/Pathoma}}
    {{#UpToDate}}<span class="pill utd">{{hint:UpToDate}}</span>{{/UpToDate}}
    {{#NBME}}<span class="pill nbme">{{hint:NBME}}</span>{{/NBME}}
    {{#Additional_Resources}}<span class="pill add">{{hint:Additional_Resources}}</span>{{/Additional_Resources}}
  </div>

  <!-- Where expanded hint blocks will be injected -->
  <div id="hintContentArea"></div>

</div>

<script>
(function () {
  const row  = document.getElementById("hintRow");
  const area = document.getElementById("hintContentArea");
  if (!row || !area) return;

  /* ---------------------------------------------------------
     We MOVE the original pill <span class="pill ..."> into the
     expanded block header, then put it back when collapsed.
     To restore the pill to its exact original position in the
     row, we insert a hidden placeholder node at that spot.
     --------------------------------------------------------- */

  const placeholders = new Map(); // key -> placeholder span
  const movedPills   = new Map(); // key -> pill span (moved element)

  /* Escape helper for dataset key lookups in querySelector */
  function esc(s){ return (s||"").replace(/\\/g,"\\\\").replace(/"/g,'\\"'); }

  /* Used to make a stable key per pill */
  function pillClassOf(a){
    const pill = a.closest(".pill");
    if (!pill) return "";
    return [...pill.classList].filter(c => c !== "pill").join(" ");
  }

  /* Stable key per pill: label + class */
  function keyOf(a){
    if (a.dataset.hkey) return a.dataset.hkey;
    const k = (a.textContent || "").trim() + "||" + pillClassOf(a);
    a.dataset.hkey = k;
    return k;
  }

  /* Find existing rendered hint block for a key */
  function getBlock(key){
    return area.querySelector('.hintBlock[data-key="' + esc(key) + '"]');
  }

  /* Toggle expanded state visuals (+ / −) */
  function setExpanded(a, on){
    a.classList.toggle("activeHint", on);
    a.setAttribute("aria-expanded", on ? "true" : "false");
  }

  /* In Anki, {{hint:Field}} creates:
       <a class="hint">Label</a>
       <div class="hint">Hidden payload</div>
     This grabs the payload div that belongs to the clicked link. */
  function siblingHint(a){
    const d = a.nextElementSibling;
    return d && d.classList && d.classList.contains("hint") ? d : null;
  }

  function findPillSpanForLink(a){
    return a.closest(".pill");
  }

  /* Move pill into expanded block header and create placeholder in row */
  function movePillIntoBlock(key, pillSpan, header){
    if (!pillSpan || !header) return;

    if (!placeholders.has(key)) {
      const ph = document.createElement("span");
      ph.className = "pillPlaceholder";
      ph.dataset.key = key;
      ph.style.display = "none";
      pillSpan.parentNode.insertBefore(ph, pillSpan);
      placeholders.set(key, ph);
    }

    movedPills.set(key, pillSpan);
    header.appendChild(pillSpan);
  }

  /* Move pill back into the row where it originally was */
  function movePillBackToRow(key){
    const pillSpan = movedPills.get(key);
    const ph = placeholders.get(key);
    if (!pillSpan || !ph) return;

    ph.parentNode.insertBefore(pillSpan, ph);
    ph.remove();

    movedPills.delete(key);
    placeholders.delete(key);
  }

  /* Create and inject an expanded hint block from raw HTML */
  function addBlockFromHtml(html, key, link){
    const block = document.createElement("div");
    block.className = "hintBlock";
    block.dataset.key = key;
    block.innerHTML = `
      <div class="hintHeader"></div>
      <div class="hintBody">${html}</div>
    `;
    area.appendChild(block);

    const header = block.querySelector(".hintHeader");
    const pillSpan = findPillSpanForLink(link);
    movePillIntoBlock(key, pillSpan, header);

    setExpanded(link, true);
    block.scrollIntoView({ block:"nearest", behavior:"smooth" });
  }

  /* Close block, remove it, move pill back to row */
  function closeBlock(key, link){
    const b = getBlock(key);
    if (b) b.remove();
    movePillBackToRow(key);
    if (link) setExpanded(link, false);
  }

  /* ---------------------------------------------------------
     CLICK HANDLER (TOGGLE)
     - If already open: close + move pill back to row
     - If closed: open block + move pill above content
     --------------------------------------------------------- */
  document.addEventListener("click", (e) => {
    const a = e.target.closest("a.hint");
    if (!a) return;

    const inOurSystem = a.closest("#hintRow") || a.closest("#hintContentArea");
    if (!inOurSystem) return;

    const key = keyOf(a);

    if (getBlock(key)) {
      e.preventDefault();
      closeBlock(key, a);
      const d = siblingHint(a);
      if (d) d.style.display = "none";
      return;
    }

    const d = siblingHint(a);
    if (d) {
      e.preventDefault();
      addBlockFromHtml(d.innerHTML, key, a);
      d.style.display = "none";
    }
  }, true);

  /* ---------------------------------------------------------
     "H" KEY SUPPORT (Anki-native hints)
     - Anki reveals the hint payload internally when you press H
     - We detect newly visible hint divs in the row
     - We render them into our own blocks and then hide the payload
     --------------------------------------------------------- */
  function captureVisible(){
    const divs = [...row.querySelectorAll("div.hint")].filter(d => d.offsetHeight > 0);
    divs.forEach(d => {
      const a = d.previousElementSibling;
      if (!a || !a.classList || !a.classList.contains("hint")) return;

      const key = keyOf(a);
      if (!getBlock(key)) addBlockFromHtml(d.innerHTML, key, a);
      else setExpanded(a, true);

      d.style.display = "none";
    });
  }

  document.addEventListener("keydown", (e) => {
    if (e.key === "h" || e.key === "H") setTimeout(captureVisible, 0);
  });
})();
</script>